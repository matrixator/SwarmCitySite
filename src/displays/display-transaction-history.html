<!--
@license
Copyright (c) 2017 Swarm City
This code may  be used under the license found at https://github.com/swarmcity/license
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../redux-state.html">
<script src="../data/webpack.min.js"></script>
<!--
    Displays and shared styles 
-->
<!--

Example:
```
<display-transaction-history></display-transaction-history>
```

-->
<dom-module id="display-transaction-history">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            .container {
                @apply --layout-vertical;
                @apply --start-justified;
                @apply --small-light;
                padding: 5vh 0 8vh 0;
                width: 100%;
            }

            .item {
                margin-bottom: 30px;
            }

            .success {
                color: var(--sc-grey3b);
            }

            .failed {
                color: red;
            }

            .failed-text {
                font-weight: bold;
            }

            .pending {
                color: var(--sc-grey3);
            }

            .pending>span {
                color: blue;
            }

            .horizontal {
                @apply --body-detail;
                @apply --layout-horizontal;
                @apply --start-justified;
            }

            .container[wide-layout] .truncate {
                width: 50vw;
            }

            .truncate {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
                width: 150px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .linkbox {
                margin-top: 5px;
            }

            .greylink {
                @apply --small-light;
                cursor: pointer;
                color: var(--sc-grey3);
                text-decoration: none;
                border-bottom: 2px dotted var(--sc-grey3b);
            }

            .bluelink {
                @apply --small-bold;
                cursor: pointer;
                color: var(--sc-blue);
                text-decoration: none;
                border-bottom: 2px dotted var(--sc-blue);
            }

            .pending-dots {
                @apply --layout-horizontal;
                margin: 2px 0px 2px 0px;
                box-sizing: border-box;
                padding: 4px;
                @apply --layout-horizontal;
                @apply --layout-end;
            }

            .smallpoint {
                margin: 0px 3px 0px 3px;
                width: 2px;
                height: 2px;
                border-radius: 50%;
                background-color: var(--sc-blue);
            }

            #point1 {
                animation: loadanimation 1.5s linear 0s infinite;
            }

            #point2 {
                animation: loadanimation 1.5s linear 0.3s infinite;
            }

            #point3 {
                animation: loadanimation 1.5s linear 0.6s infinite;
            }

            @keyframes loadanimation {
                0% {
                    transform: scale(1);
                    opacity: 0.2;
                }
                25% {
                    transform: scale(1.5);
                    opacity: 1;
                }
                50% {
                    transform: scale(1);
                    opacity: 0.2;
                }
                100% {
                    transform: scale(1);
                    opacity: 0;
                }
            }
        </style>
        <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>
        <div class="container" wide-layout$="{{wide}}">

            <template is="dom-repeat" items="{{txHistory}}">
                <div class="item">
                    <div class$="[[_checkState(item.status)]]">
                        <div class="date">[[_formatDate(item.dateTime)]]</div>
                        <div class="horizontal">

                            <template is="dom-if" if="[[_isFailed(item.status)]]">
                                <span class="failed-text">Failed:&nbsp;</span>
                            </template>

                            <template is="dom-if" if="[[_isIncoming(item.direction)]]">+&nbsp;</template>
                            <template is="dom-if" if="[[_isOutgoing(item.direction)]]">-&nbsp;</template>

                            <div>[[_format(item.amount)]]&nbsp;SWT&nbsp;</div>

                            <template is="dom-if" if="[[!_isPending(item.status)]]">
                                <template is="dom-if" if="[[_isIncoming(item.direction)]]">from&nbsp;
                                    <span class="truncate">[[item.from]]</span>
                                </template>
                                <template is="dom-if" if="[[_isOutgoing(item.direction)]]">to&nbsp;
                                    <span class="truncate">[[item.to]]</span>
                                </template>
                            </template>

                            <template is="dom-if" if="[[_isPending(item.status)]]">
                                <div class="pending-dots">
                                    <div class="smallpoint" id="point1"></div>
                                    <div class="smallpoint" id="point2"></div>
                                    <div class="smallpoint" id="point3"></div>
                                </div>
                            </template>

                        </div>

                        <template is="dom-if" if="[[_isPending(item.status)]]">
                            <div class="horizontal">
                                <template is="dom-if" if="[[_isIncoming(item.direction)]]">Receiving from&nbsp;
                                    <span class="truncate">[[item.from]]</span>
                                </template>
                                <template is="dom-if" if="[[_isOutgoing(item.direction)]]">Sending to&nbsp;
                                    <span class="truncate">[[item.to]]</span>
                                </template>
                            </div>
                        </template>

                    </div>
                    <div class="linkbox">
                        <span class$="[[_checkLinkStyle(item.status)]]" on-click="_toEtherscan">show on etherscan</span>
                    </div>
                </div>
            </template>

        </div>

    </template>
    <script>
        class MyDisplayTransactionHistory extends new ReduxMixin(Polymer.mixinBehaviors([
            Polymer.AppLocalizeBehavior,
        ],
            Polymer.Element
        )) {
            static get is() {
                return 'display-transaction-history';
            }
            static get properties() {
                return {
                    /**
                    * The language as chosen by user
                    * @type {String}
                    */
                    language: {
                        type: String,
                        statePath: 'language',
                    },
                    /**
                    * An array containing the transaction history for this public key
                    * @type {Array}
                    */
                    txHistory: {
                        type: Array,
                        statePath: 'txhistory',
                        observer: '_txHistoryChanged',
                    },
                    /**
                    * An array containing the pending outgoing transactions for this public key
                    * @type {Array}
                    */
                    pendingTx: {
                        type: Array,
                        statePath: 'pendingTx',
                    },
                };
            }

            connectedCallback() {
                super.connectedCallback();
                this.loadResources(this.resolveUrl('../text-translations.json'));
                let tempPendingTx = [{
                    amount: '666',
                    direction: 'out',
                    status: 2,
                    from: '0xC9E5a19Fdc73648e15E08Ec5117FB4370992041B',
                    symbol: 'SWT',
                    to: '0xc28cb3E2cB9Ceb316106E3c54A4611c271f7C62c',
                    transactionHash: '0x0609ea0e05a76076ccd7f3fba6dsdb3d38cfc300be8cfb5e7b341c5c8c7b48c8',
                }, {
                    amount: '123',
                    direction: 'out',
                    status: 2,
                    from: '0xC9E5a19Fdc73648e15E08Ec5117FB4370992041B',
                    symbol: 'SWT',
                    to: '0xc28cb3E2cB9Ceb316106E3c54A4611c271f7C62c',
                    transactionHash: '0xa7d8a0ef14e387ebcca806499cbf4c4840a99fddc6b44e4de4ac13fb07ffd568',
                }];
                this.dispatch('PENDINGTX', tempPendingTx);
            }
            /**
            * Redux action for setting the txHistory
            * @param {Array} txhistory
            */
            static get actions() {
                return Object.assign({
                    TXHISTORY: function(txhistory) {
                        return {
                            type: 'TXHISTORY',
                            txhistory: txhistory,
                        };
                    },
                    PENDINGTX: function(pendingTx) {
                        return {
                            type: 'PENDINGTX',
                            pendingTx: pendingTx,
                        };
                    },
                });
            }

            /**
            * returns style class depending on item status
            * @param {Number} status statuscode of item
            * @return {string} classname
            */
            _checkState(status) {
                switch (status) {
                    case 0:
                        return 'success';
                    case 1:
                        return 'failed';
                    case 2:
                        return 'pending';
                    default:
                        return 'success';
                }
            }

            /**
            * returns true if transaction is outgoing
            * @param {string} direction direction of transaction
            * @return {boolean} boolean
            */
            _isOutgoing(direction) {
                return direction == 'out' ? true : false;
            }

            /**
            * returns true if transaction is incoming
            * @param {string} direction direction of transaction
            * @return {boolean} boolean
            */
            _isIncoming(direction) {
                return direction == 'in' ? true : false;
            }

            /**
            * returns true if transactioncode states pending
            * @param {Number} status statuscode of item
            * @return {boolean} boolean
            */
            _isPending(status) {
                return status == 2 ? true : false;
            }

            /**
            * returns true if transactioncode states success
            * @param {Number} status statuscode of item
            * @return {boolean} boolean
            */
            _isSucces(status) {
                return status == 0 ? true : false;
            }

            /**
            * returns true if transactioncode states failed
            * @param {Number} status statuscode of item
            * @return {boolean} boolean
            */
            _isFailed(status) {
                return status == 1 ? true : false;
            }

            /**
            * formats epoch
            * @param {DateTime} dateTime epoch in javascript milliseconds
            * @return {string} formatted date string
            */
            _formatDate(dateTime) {
                let milliseconds = dateTime * 1000;
                if (webpack.moment().valueOf() - milliseconds < 86400000) {
                    return webpack.moment(milliseconds).fromNow();
                } else {
                    return webpack.moment(milliseconds).format('DD MMM YYYY - HH:mm');
                }
            }

            /**
            * formats amount to more readable format
            * @param {Number} amount amount that has been transferred
            * @return {Number} formatted amount
            */
            _format(amount) {
                return amount;
            }

            /**
            * switches to correct styling depending on item status
            * @param {Number} status statuscode of item
            * @return {string} classname
            */
            _checkLinkStyle(status) {
                return status == 2 ? 'bluelink' : 'greylink';
            }

            /**
            * takes the user to txhash page on etherscan
            * @param {Object} event element clicked
            */
            _toEtherscan(event) {
                window.open('https://rinkeby.etherscan.io/tx/'
                    + event.model.__data.item.transactionHash, '_blank');
            }
            /**
            * On every new txHistory Array received, we check if the pending tx's got confirmed
            */
            _txHistoryChanged() {
                // Verify if pending tx has been confirmed, remove from pendingTx list if so
                let newPendingTx = this.pendingTx;
                for (let confirmedTx of this.txHistory) {
                    for (let i = 0; i < newPendingTx.length; i++ ) {
                        if (confirmedTx.transactionHash == newPendingTx[i].transactionHash) {
                            newPendingTx.splice(i, 1);
                        }
                    }
                }
                // Add remaining pendingTx to the txHistory array
                let newTxHistory = this.txHistory;
                for (let pendingTx of newPendingTx) {
                    newTxHistory.unshift(pendingTx);
                }

                // Dispatch new arrays to redux
                this.dispatch('PENDINGTX', newPendingTx);
                this.dispatch('TXHISTORY', newTxHistory);
            }
        }

        window.customElements
            .define(MyDisplayTransactionHistory.is, MyDisplayTransactionHistory);
    </script>
</dom-module>